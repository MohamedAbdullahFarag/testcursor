using Xunit.Framework;
using AutoMapper;
using Microsoft.Extensions.Logging;
using Moq;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using Ikhtibar.Core.Services.Implementations;
using Ikhtibar.Core.Services.Interfaces;
using Ikhtibar.Core.Repositories.Interfaces;
using Ikhtibar.Shared.DTOs;
using Ikhtibar.Shared.Entities;

namespace Ikhtibar.Tests.Core.Services;

/// <summary>
/// Comprehensive test suite for RoleService business logic.
/// Tests all CRUD operations, validation rules, and error scenarios.
/// Uses AAA pattern (Arrange, Act, Assert) with descriptive test names.
/// Includes integration with mocked dependencies and database.
/// </summary>

[TestFixture]
public class RoleServiceTests
{
    private Mock<IRoleRepository> _mockRoleRepository;
    private Mock<IMapper> _mockMapper;
    private Mock<ILogger<RoleService>> _mockLogger;
    private RoleService _roleService;

    [SetUp]
    public void Setup()
    {
        _mockRoleRepository = new Mock<IRoleRepository>();
        _mockMapper = new Mock<IMapper>();
        _mockLogger = new Mock<ILogger<RoleService>>();

        _roleService = new RoleService(
            _mockRoleRepository.Object,
            _mockMapper.Object,
            _mockLogger.Object
        );
    }

    #region CreateRoleAsync Tests

    /// <summary>
    /// Test: Creating role with valid data should return role DTO with generated ID
    /// Scenario: Happy path with all required fields provided
    /// Expected: Role created successfully with proper mapping and validation
    /// </summary>
    [Test]
    public async Task CreateRoleAsync_Should_CreateRole_When_ValidDataProvided()
    {
        // Arrange
        var createRoleDto = new CreateRoleDto
        {
            Code = "test-role",
            Name = "Test Role",
            Description = "Test role description"
        };

        var role = new Role
        {
            RoleId = 1,
            Code = "test-role",
            Name = "Test Role",
            Description = "Test role description",
            IsSystemRole = false
        };

        var roleDto = new RoleDto
        {
            RoleId = 1,
            Code = "test-role",
            Name = "Test Role",
            Description = "Test role description",
            IsSystemRole = false
        };

        _mockRoleRepository.Setup(x => x.IsRoleCodeInUseAsync("test-role", null))
                          .ReturnsAsync(false);
        _mockMapper.Setup(x => x.Map<Role>(createRoleDto))
                   .Returns(role);
        _mockRoleRepository.Setup(x => x.CreateAsync(role))
                          .ReturnsAsync(role);
        _mockMapper.Setup(x => x.Map<RoleDto>(role))
                   .Returns(roleDto);

        // Act
        var result = await _roleService.CreateRoleAsync(createRoleDto);

        // Assert
        Assert.That(result, Is.Not.Null);
        Assert.That(result.Code, Is.EqualTo("test-role"));
        Assert.That(result.Name, Is.EqualTo("Test Role"));
        Assert.That(result.IsSystemRole, Is.False);
        
        _mockRoleRepository.Verify(x => x.IsRoleCodeInUseAsync("test-role", null), Times.Once);
        _mockRoleRepository.Verify(x => x.CreateAsync(It.IsAny<Role>()), Times.Once);
    }

    /// <summary>
    /// Test: Creating role with existing code should throw exception
    /// Scenario: Duplicate role code validation
    /// Expected: Exception with appropriate message and no database changes
    /// </summary>
    [Test]
    public async Task CreateRoleAsync_Should_ThrowException_When_CodeExists()
    {
        // Arrange
        var createRoleDto = new CreateRoleDto
        {
            Code = "existing-role",
            Name = "Test Role",
            Description = "Test role description"
        };

        _mockRoleRepository.Setup(x => x.IsRoleCodeInUseAsync("existing-role", null))
                          .ReturnsAsync(true);

        // Act & Assert
        var exception = await Assert.ThrowsAsync<InvalidOperationException>(
            () => _roleService.CreateRoleAsync(createRoleDto));

        StringAssert.Contains("already exists", exception.Message);
        _mockRoleRepository.Verify(x => x.CreateAsync(It.IsAny<Role>()), Times.Never);
    }

    /// <summary>
    /// Test: Creating role with null DTO should throw ArgumentNullException
    /// Scenario: Null input validation
    /// Expected: ArgumentNullException before any repository calls
    /// </summary>
    [Test]
    public async Task CreateRoleAsync_Should_ThrowArgumentNullException_When_DtoIsNull()
    {
        // Act & Assert
        await Assert.ThrowsAsync<ArgumentNullException>(
            () => _roleService.CreateRoleAsync(null));

        _mockRoleRepository.Verify(x => x.CreateAsync(It.IsAny<Role>()), Times.Never);
    }

    #endregion

    #region GetRoleAsync Tests

    /// <summary>
    /// Test: Getting existing role should return role DTO
    /// Scenario: Valid role ID provided
    /// Expected: Role DTO with correct data returned
    /// </summary>
    [Test]
    public async Task GetRoleAsync_Should_ReturnRoleDto_When_RoleExists()
    {
        // Arrange
        var roleId = 1;
        var role = new Role
        {
            RoleId = roleId,
            Code = "test-role",
            Name = "Test Role",
            Description = "Test role description"
        };

        var roleDto = new RoleDto
        {
            RoleId = roleId,
            Code = "test-role",
            Name = "Test Role",
            Description = "Test role description"
        };

        _mockRoleRepository.Setup(x => x.GetByIdAsync(roleId))
                          .ReturnsAsync(role);
        _mockMapper.Setup(x => x.Map<RoleDto>(role))
                   .Returns(roleDto);

        // Act
        var result = await _roleService.GetRoleAsync(roleId);

        // Assert
        Assert.That(result, Is.Not.Null);
        Assert.That(result.RoleId, Is.EqualTo(roleId));
        Assert.That(result.Code, Is.EqualTo("test-role"));
    }

    /// <summary>
    /// Test: Getting non-existing role should return null
    /// Scenario: Invalid role ID provided
    /// Expected: Null returned without throwing exception
    /// </summary>
    [Test]
    public async Task GetRoleAsync_Should_ReturnNull_When_RoleNotExists()
    {
        // Arrange
        var roleId = 999;
        _mockRoleRepository.Setup(x => x.GetByIdAsync(roleId))
                          .ReturnsAsync((Role)null);

        // Act
        var result = await _roleService.GetRoleAsync(roleId);

        // Assert
        Assert.IsNull(result);
    }

    #endregion

    #region UpdateRoleAsync Tests

    /// <summary>
    /// Test: Updating custom role should succeed
    /// Scenario: Valid update data for non-system role
    /// Expected: Role updated successfully with new data
    /// </summary>
    [Test]
    public async Task UpdateRoleAsync_Should_UpdateRole_When_ValidCustomRole()
    {
        // Arrange
        var roleId = 1;
        var updateRoleDto = new UpdateRoleDto
        {
            Name = "Updated Role",
            Description = "Updated description"
        };

        var existingRole = new Role
        {
            RoleId = roleId,
            Code = "custom-role",
            Name = "Original Role",
            Description = "Original description",
            IsSystemRole = false
        };

        var updatedRole = new Role
        {
            RoleId = roleId,
            Code = "custom-role",
            Name = "Updated Role",
            Description = "Updated description",
            IsSystemRole = false
        };

        var resultDto = new RoleDto
        {
            RoleId = roleId,
            Code = "custom-role",
            Name = "Updated Role",
            Description = "Updated description",
            IsSystemRole = false
        };

        _mockRoleRepository.Setup(x => x.GetByIdAsync(roleId))
                          .ReturnsAsync(existingRole);
        _mockRoleRepository.Setup(x => x.UpdateAsync(It.IsAny<Role>()))
                          .ReturnsAsync(updatedRole);
        _mockMapper.Setup(x => x.Map<RoleDto>(updatedRole))
                   .Returns(resultDto);

        // Act
        var result = await _roleService.UpdateRoleAsync(roleId, updateRoleDto);

        // Assert
        Assert.That(result, Is.Not.Null);
        Assert.That(result.Name, Is.EqualTo("Updated Role"));
        Assert.That(result.Description, Is.EqualTo("Updated description"));
        
        _mockRoleRepository.Verify(x => x.UpdateAsync(It.IsAny<Role>()), Times.Once);
    }

    /// <summary>
    /// Test: Updating system role should throw exception
    /// Scenario: Attempt to modify system role
    /// Expected: Exception thrown with no database changes
    /// </summary>
    [Test]
    public async Task UpdateRoleAsync_Should_ThrowException_When_SystemRole()
    {
        // Arrange
        var roleId = 1;
        var updateRoleDto = new UpdateRoleDto
        {
            Name = "Updated Role",
            Description = "Updated description"
        };

        var systemRole = new Role
        {
            RoleId = roleId,
            Code = "system-admin",
            Name = "System Administrator",
            IsSystemRole = true
        };

        _mockRoleRepository.Setup(x => x.GetByIdAsync(roleId))
                          .ReturnsAsync(systemRole);

        // Act & Assert
        var exception = await Assert.ThrowsAsync<InvalidOperationException>(
            () => _roleService.UpdateRoleAsync(roleId, updateRoleDto));

        StringAssert.Contains("system role", exception.Message);
        _mockRoleRepository.Verify(x => x.UpdateAsync(It.IsAny<Role>()), Times.Never);
    }

    #endregion

    #region DeleteRoleAsync Tests

    /// <summary>
    /// Test: Deleting custom role should succeed
    /// Scenario: Valid deletion of non-system role
    /// Expected: Role deleted successfully
    /// </summary>
    [Test]
    public async Task DeleteRoleAsync_Should_DeleteRole_When_ValidCustomRole()
    {
        // Arrange
        var roleId = 1;
        var customRole = new Role
        {
            RoleId = roleId,
            Code = "custom-role",
            IsSystemRole = false
        };

        _mockRoleRepository.Setup(x => x.GetByIdAsync(roleId))
                          .ReturnsAsync(customRole);
        _mockRoleRepository.Setup(x => x.DeleteAsync(roleId))
                          .ReturnsAsync(true);

        // Act
        var result = await _roleService.DeleteRoleAsync(roleId);

        // Assert
        Assert.IsTrue(result);
        _mockRoleRepository.Verify(x => x.DeleteAsync(roleId), Times.Once);
    }

    /// <summary>
    /// Test: Deleting system role should throw exception
    /// Scenario: Attempt to delete protected system role
    /// Expected: Exception thrown with no database changes
    /// </summary>
    [Test]
    public async Task DeleteRoleAsync_Should_ThrowException_When_SystemRole()
    {
        // Arrange
        var roleId = 1;
        var systemRole = new Role
        {
            RoleId = roleId,
            Code = "system-admin",
            IsSystemRole = true
        };

        _mockRoleRepository.Setup(x => x.GetByIdAsync(roleId))
                          .ReturnsAsync(systemRole);

        // Act & Assert
        var exception = await Assert.ThrowsAsync<InvalidOperationException>(
            () => _roleService.DeleteRoleAsync(roleId));

        StringAssert.Contains("system role", exception.Message);
        _mockRoleRepository.Verify(x => x.DeleteAsync(It.IsAny<int>()), Times.Never);
    }

    /// <summary>
    /// Test: Deleting non-existing role should return false
    /// Scenario: Invalid role ID provided
    /// Expected: False returned without throwing exception
    /// </summary>
    [Test]
    public async Task DeleteRoleAsync_Should_ReturnFalse_When_RoleNotExists()
    {
        // Arrange
        var roleId = 999;
        _mockRoleRepository.Setup(x => x.GetByIdAsync(roleId))
                          .ReturnsAsync((Role)null);

        // Act
        var result = await _roleService.DeleteRoleAsync(roleId);

        // Assert
        Assert.IsFalse(result);
        _mockRoleRepository.Verify(x => x.DeleteAsync(It.IsAny<int>()), Times.Never);
    }

    #endregion

    #region GetAllRolesAsync Tests

    /// <summary>
    /// Test: Getting all roles should return complete list
    /// Scenario: Repository contains multiple roles
    /// Expected: All roles returned with proper mapping
    /// </summary>
    [Test]
    public async Task GetAllRolesAsync_Should_ReturnAllRoles_When_RolesExist()
    {
        // Arrange
        var roles = new List<Role>
        {
            new Role { RoleId = 1, Code = "admin", Name = "Administrator" },
            new Role { RoleId = 2, Code = "user", Name = "User" }
        };

        var roleDtos = new List<RoleDto>
        {
            new RoleDto { RoleId = 1, Code = "admin", Name = "Administrator" },
            new RoleDto { RoleId = 2, Code = "user", Name = "User" }
        };

        _mockRoleRepository.Setup(x => x.GetAllAsync())
                          .ReturnsAsync(roles);
        _mockMapper.Setup(x => x.Map<IEnumerable<RoleDto>>(roles))
                   .Returns(roleDtos);

        // Act
        var result = await _roleService.GetAllRolesAsync();

        // Assert
        Assert.That(result, Is.Not.Null);
        Assert.That(result.Count(), Is.EqualTo(2));
        Assert.That(result, Is.EquivalentTo(roleDtos));
    }

    /// <summary>
    /// Test: Getting all roles when none exist should return empty list
    /// Scenario: Repository is empty
    /// Expected: Empty enumerable returned
    /// </summary>
    [Test]
    public async Task GetAllRolesAsync_Should_ReturnEmptyList_When_NoRolesExist()
    {
        // Arrange
        var emptyRoles = new List<Role>();
        var emptyRoleDtos = new List<RoleDto>();

        _mockRoleRepository.Setup(x => x.GetAllAsync())
                          .ReturnsAsync(emptyRoles);
        _mockMapper.Setup(x => x.Map<IEnumerable<RoleDto>>(emptyRoles))
                   .Returns(emptyRoleDtos);

        // Act
        var result = await _roleService.GetAllRolesAsync();

        // Assert
        Assert.That(result, Is.Not.Null);
        Assert.That(result.Count(), Is.EqualTo(0));
    }

    #endregion

    #region GetRoleByCodeAsync Tests

    /// <summary>
    /// Test: Getting role by valid code should return role DTO
    /// Scenario: Role exists with specified code
    /// Expected: Correct role DTO returned
    /// </summary>
    [Test]
    public async Task GetRoleByCodeAsync_Should_ReturnRole_When_CodeExists()
    {
        // Arrange
        var roleCode = "admin";
        var role = new Role
        {
            RoleId = 1,
            Code = roleCode,
            Name = "Administrator"
        };

        var roleDto = new RoleDto
        {
            RoleId = 1,
            Code = roleCode,
            Name = "Administrator"
        };

        _mockRoleRepository.Setup(x => x.GetByCodeAsync(roleCode))
                          .ReturnsAsync(role);
        _mockMapper.Setup(x => x.Map<RoleDto>(role))
                   .Returns(roleDto);

        // Act
        var result = await _roleService.GetRoleByCodeAsync(roleCode);

        // Assert
        Assert.That(result, Is.Not.Null);
        Assert.That(result.Code, Is.EqualTo(roleCode));
        Assert.That(result.Name, Is.EqualTo("Administrator"));
    }

    /// <summary>
    /// Test: Getting role by invalid code should return null
    /// Scenario: Role does not exist with specified code
    /// Expected: Null returned
    /// </summary>
    [Test]
    public async Task GetRoleByCodeAsync_Should_ReturnNull_When_CodeNotExists()
    {
        // Arrange
        var roleCode = "nonexistent";
        _mockRoleRepository.Setup(x => x.GetByCodeAsync(roleCode))
                          .ReturnsAsync((Role)null);

        // Act
        var result = await _roleService.GetRoleByCodeAsync(roleCode);

        // Assert
        Assert.IsNull(result);
    }

    #endregion

    #region RoleExistsAsync Tests

    /// <summary>
    /// Test: Checking existing role should return true
    /// Scenario: Role exists in repository
    /// Expected: True returned
    /// </summary>
    [Test]
    public async Task RoleExistsAsync_Should_ReturnTrue_When_RoleExists()
    {
        // Arrange
        var roleId = 1;
        _mockRoleRepository.Setup(x => x.RoleExistsAsync(roleId))
                          .ReturnsAsync(true);

        // Act
        var result = await _roleService.RoleExistsAsync(roleId);

        // Assert
        Assert.IsTrue(result);
    }

    /// <summary>
    /// Test: Checking non-existing role should return false
    /// Scenario: Role does not exist in repository
    /// Expected: False returned
    /// </summary>
    [Test]
    public async Task RoleExistsAsync_Should_ReturnFalse_When_RoleNotExists()
    {
        // Arrange
        var roleId = 999;
        _mockRoleRepository.Setup(x => x.RoleExistsAsync(roleId))
                          .ReturnsAsync(false);

        // Act
        var result = await _roleService.RoleExistsAsync(roleId);

        // Assert
        Assert.IsFalse(result);
    }

    #endregion

    #region Error Handling Tests

    /// <summary>
    /// Test: Repository exception should be propagated
    /// Scenario: Repository throws exception during operation
    /// Expected: Exception propagated to caller with proper logging
    /// </summary>
    [Test]
    public async Task CreateRoleAsync_Should_PropagateException_When_RepositoryFails()
    {
        // Arrange
        var createRoleDto = new CreateRoleDto
        {
            Code = "test-role",
            Name = "Test Role"
        };

        _mockRoleRepository.Setup(x => x.IsRoleCodeInUseAsync(It.IsAny<string>(), It.IsAny<int?>()))
                          .ReturnsAsync(false);
        _mockMapper.Setup(x => x.Map<Role>(createRoleDto))
                   .Returns(new Role());
        _mockRoleRepository.Setup(x => x.CreateAsync(It.IsAny<Role>()))
                          .ThrowsAsync(new Exception("Database error"));

        // Act & Assert
        var exception = await Assert.ThrowsAsync<Exception>(
            () => _roleService.CreateRoleAsync(createRoleDto));

        Assert.AreEqual("Database error", exception.Message);
    }

    #endregion
}
