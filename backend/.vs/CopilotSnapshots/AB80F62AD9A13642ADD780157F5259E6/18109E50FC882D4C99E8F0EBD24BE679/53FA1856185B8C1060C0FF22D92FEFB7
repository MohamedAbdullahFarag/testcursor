using Xunit.Framework;
using Microsoft.AspNetCore.Http;
using Microsoft.Extensions.Logging;
using Moq;
using System.Text.Json;
using Ikhtibar.API.Middleware;

namespace Ikhtibar.Tests.API.Middleware
{
    /// <summary>
    /// Tests for ErrorHandlingMiddleware functionality
    /// </summary>
    [TestFixture]
    public class ErrorHandlingMiddlewareTests
    {
        private Mock<ILogger<ErrorHandlingMiddleware>> _mockLogger;
        private ErrorHandlingMiddleware _middleware;
        private HttpContext _httpContext;
        private Mock<RequestDelegate> _mockNext;

        [SetUp]
        public void Setup()
        {
            _mockLogger = new Mock<ILogger<ErrorHandlingMiddleware>>();
            _mockNext = new Mock<RequestDelegate>();
            _middleware = new ErrorHandlingMiddleware(_mockNext.Object, _mockLogger.Object);

            _httpContext = new DefaultHttpContext();
            _httpContext.Response.Body = new MemoryStream();
        }

        [Test]
        public async Task InvokeAsync_WhenNoException_ShouldCallNextMiddleware()
        {
            // Arrange
            _mockNext.Setup(x => x(It.IsAny<HttpContext>()))
                    .Returns(Task.CompletedTask);

            // Act
            await _middleware.InvokeAsync(_httpContext);

            // Assert
            _mockNext.Verify(x => x(_httpContext), Times.Once);
            Assert.AreEqual(200, _httpContext.Response.StatusCode);
        }

        [Test]
        public async Task InvokeAsync_WhenExceptionOccurs_ShouldReturn500WithProblemDetails()
        {
            // Arrange
            var exception = new InvalidOperationException("Test exception");
            _mockNext.Setup(x => x(It.IsAny<HttpContext>()))
                    .ThrowsAsync(exception);

            // Act
            await _middleware.InvokeAsync(_httpContext);

            // Assert
            Assert.AreEqual(500, _httpContext.Response.StatusCode);
            Assert.AreEqual("application/problem+json", _httpContext.Response.ContentType);

            // Verify response body contains problem details
            _httpContext.Response.Body.Seek(0, SeekOrigin.Begin);
            using var reader = new StreamReader(_httpContext.Response.Body);
            var responseBody = await reader.ReadToEndAsync();

            Assert.That(responseBody, Is.Not.Empty);
            Assert.That(responseBody, Contains.Substring("Test exception"));
        }

        [Test]
        public async Task InvokeAsync_WhenArgumentExceptionOccurs_ShouldReturn400WithProblemDetails()
        {
            // Arrange
            var exception = new ArgumentException("Invalid argument", "paramName");
            _mockNext.Setup(x => x(It.IsAny<HttpContext>()))
                    .ThrowsAsync(exception);

            // Act
            await _middleware.InvokeAsync(_httpContext);

            // Assert
            Assert.AreEqual(400, _httpContext.Response.StatusCode);
            Assert.AreEqual("application/problem+json", _httpContext.Response.ContentType);
        }

        [Test]
        public async Task InvokeAsync_WhenUnauthorizedAccessExceptionOccurs_ShouldReturn401WithProblemDetails()
        {
            // Arrange
            var exception = new UnauthorizedAccessException("Access denied");
            _mockNext.Setup(x => x(It.IsAny<HttpContext>()))
                    .ThrowsAsync(exception);

            // Act
            await _middleware.InvokeAsync(_httpContext);

            // Assert
            Assert.AreEqual(401, _httpContext.Response.StatusCode);
            Assert.AreEqual("application/problem+json", _httpContext.Response.ContentType);
        }

        [Test]
        public async Task InvokeAsync_WhenKeyNotFoundExceptionOccurs_ShouldReturn404WithProblemDetails()
        {
            // Arrange
            var exception = new KeyNotFoundException("Resource not found");
            _mockNext.Setup(x => x(It.IsAny<HttpContext>()))
                    .ThrowsAsync(exception);

            // Act
            await _middleware.InvokeAsync(_httpContext);

            // Assert
            Assert.AreEqual(404, _httpContext.Response.StatusCode);
            Assert.AreEqual("application/problem+json", _httpContext.Response.ContentType);
        }

        [Test]
        public async Task InvokeAsync_WhenExceptionOccurs_ShouldLogError()
        {
            // Arrange
            var exception = new Exception("Test exception");
            _mockNext.Setup(x => x(It.IsAny<HttpContext>()))
                    .ThrowsAsync(exception);

            // Act
            await _middleware.InvokeAsync(_httpContext);

            // Assert
            _mockLogger.Verify(
                x => x.Log(
                    LogLevel.Error,
                    It.IsAny<EventId>(),
                    It.Is<It.IsAnyType>((v, t) => true),
                    exception,
                    It.IsAny<Func<It.IsAnyType, Exception?, string>>()),
                Times.Once);
        }

        [Test]
        public async Task InvokeAsync_WhenExceptionOccurs_ShouldSetCorrelationId()
        {
            // Arrange
            var exception = new Exception("Test exception");
            _mockNext.Setup(x => x(It.IsAny<HttpContext>()))
                    .ThrowsAsync(exception);

            // Act
            await _middleware.InvokeAsync(_httpContext);

            // Assert
            Assert.That(_httpContext.Response.Headers.ContainsKey("X-Correlation-ID"), Is.True);
            Assert.That(_httpContext.Response.Headers["X-Correlation-ID"], Is.Not.Empty);
        }

        [Test]
        public async Task InvokeAsync_WhenExceptionOccurs_ShouldReturnValidJson()
        {
            // Arrange
            var exception = new Exception("Test exception");
            _mockNext.Setup(x => x(It.IsAny<HttpContext>()))
                    .ThrowsAsync(exception);

            // Act
            await _middleware.InvokeAsync(_httpContext);

            // Assert
            _httpContext.Response.Body.Seek(0, SeekOrigin.Begin);
            using var reader = new StreamReader(_httpContext.Response.Body);
            var responseBody = await reader.ReadToEndAsync();

            // Verify it's valid JSON
            Assert.DoesNotThrow(() => JsonDocument.Parse(responseBody));

            // Verify it contains expected fields
            var jsonDoc = JsonDocument.Parse(responseBody);
            var root = jsonDoc.RootElement;

            Assert.That(root.TryGetProperty("type", out _), Is.True);
            Assert.That(root.TryGetProperty("title", out _), Is.True);
            Assert.That(root.TryGetProperty("status", out _), Is.True);
            Assert.That(root.TryGetProperty("detail", out _), Is.True);
        }
    }
}

